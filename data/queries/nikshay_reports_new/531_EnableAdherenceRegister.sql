#@HFsector int, --{0: ALL, 1: Public, 2: Private}
#@Gender int, --{All : 0, Male : 1, Female : 2, Transgender:3}
#@Age int, --{All : 0, <15 : 1, >= 15 : 2}
#@TBCaseTypes int, --{All: 0, DS-TB:1, DRTB:2, TPT:3}
#@SiteOfDisease int, --{All: 0, Others:1, Extra pulmonary:2, Pulmonary:3}
#@ViewBy int, --{1: Notification, 2: Current}
#@DateType int, --{9: Enrollment Date}, {11: Notification Date}, {14:Treatment Start Date}
#@ValidateDate datetime = '2000-01-01'

CREATE PROCEDURE [dbo].[AdherenceRegister] @startdate date, @Enddate date, @HFsector int, @Gender int, @Age int, @TBCaseTypes int, @SiteOfDisease int, @StateID int, @DistrictID int, @TbuID int, @HFID int, @userName nvarchar(200), @ViewBy int, @DateType int, @ValidateDate datetime = '2000-01-01' as BEGIN DECLARE @lateralLogin INT SET @lateralLogin = ISNULL(dbo.GetLateralUser(@userName),0); BEGIN SELECT P.Id [Patient ID], IIR.Id,(CASE WHEN P.ParentEpisodeId IS NULL THEN P.Id ELSE P.ParentEpisodeId END) [Episode ID], P.FirstName+' '+P.LastName [Name], P.PrimaryPhone, P.Age, P.Gender, P.[Address], HC.Level_2_Name [Current Facility - State], HC.Level_3_Name [Current Facility - District], HC.Level_4_Name [Current Facility - TU], HC.[Name] [Current Facility - PHI/ HF], HD.Level_2_Name [Diagnosed Facility - State], HD.Level_3_Name [Diagnosed Facility - District], HD.Level_4_Name [Diagnosed Facility - TU], HD.[Name] [Diagnosed Facility - PHI/ HF], ISNULL(HR.Level_2_Name, '') [Residence Facility - State], ISNULL(HR.Level_3_Name, '') [Residence Facility - District], ISNULL(HR.Level_4_Name, '') [Residence Facility - TU], P.TypeOfPatient [Health facility Sector Type], P.TypeOfCase [Type of Treatment], P.Stage [Patient Status(Treatment Not Started/On Treatment)], CAST(P.TBTreatmentStartDate AS Date) [Treatment initiation Date], IIA.name [AdherenceTech], ISNULL(P.TreatmentOutcome,'') [TreatmentOutcome], CAST(P.EndDate AS Date) [Treatment Outcome Date], LEN(IIR.adh_string) - LEN(REPLACE(IIR.adh_string,'0','')) AS [QUIET], LEN(IIR.adh_string) - LEN(REPLACE(IIR.adh_string,'1','')) AS [ENDED], LEN(IIR.adh_string) - LEN(REPLACE(IIR.adh_string,'2','')) AS [MISSED], LEN(IIR.adh_string) - LEN(REPLACE(IIR.adh_string,'3','')) AS [UNVALIDATED], LEN(IIR.adh_string) - LEN(REPLACE(IIR.adh_string,'4','')) AS [RECEIVED], LEN(IIR.adh_string) - LEN(REPLACE(IIR.adh_string,'5','')) AS [RECEIVED_UNSURE], LEN(IIR.adh_string) - LEN(REPLACE(IIR.adh_string,'6','')) AS [NO_INFO], LEN(IIR.adh_string) - LEN(REPLACE(IIR.adh_string,'7','')) AS [BLANK], LEN(IIR.adh_string) - LEN(REPLACE(IIR.adh_string,'8','')) AS [ENROLLMENT], LEN(IIR.adh_string) - LEN(REPLACE(IIR.adh_string,'9','')) AS [MANUAL], LEN(IIR.adh_string) - LEN(REPLACE(IIR.adh_string,'A','')) AS [TFN_REPEAT_RECEIVED], LEN(IIR.adh_string) - LEN(REPLACE(IIR.adh_string,'B','')) AS [TFN_REPEAT_RECEIVED_UNSURE], LEN(IIR.adh_string) - LEN(REPLACE(IIR.adh_string,'C','')) AS [RECEIVED_UNSCHEDULED], LEN(IIR.adh_string) - LEN(REPLACE(IIR.adh_string,'D','')) AS [PATIENT_MANUAL], LEN(IIR.adh_string) - LEN(REPLACE(IIR.adh_string,'E','')) AS [PATIENT_MISSED], ( [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 3, 8, IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 3, 4, IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 3, 5, IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 3, 1, IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 3, 'A', IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 3, 'B', IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 3, 3, IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 3, 'C', IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 3, 9, IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 3, 'D', IIR.adh_string)) [Doses taken last 3 days(Tech + Manual)], ( [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 7, 8, IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 7, 4, IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 7, 5, IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 7, 1, IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 7, 'A', IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 7, 'B', IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 7, 3, IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 7, 'C', IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 7, 9, IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 7, 'D', IIR.adh_string) ) [Doses taken last 7 days(Tech + Manual)], ( [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 30, 8, IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 30, 4, IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 30, 5, IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 30, 1, IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 30, 'A', IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 30, 'B', IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 30, 3, IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 30, 'C', IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 30, 9, IIR.adh_string) + [dbo].[getAdherenceDoses](IIR.start_date, IIR.end_date, 30, 'D', IIR.adh_string) ) [Doses taken last 30 days(Tech + Manual)], IIR.adh_string [Adhererence string (day wise data)], calledDoses=0, calledAndManualDoses =0, total = 0, MissedDoses = 0, ManualDoses =0 INTO #Temp_ARD FROM _Patient P JOIN _Hierarchy H on H.Level=5 and P.Deleted=0 AND H.Id = IIF(@viewBy = 1,P.HierarchyMapping_Diagnosed,P.HierarchyMapping_Current) LEFT JOIN _Hierarchy HD ON HD.Id = P.HierarchyMapping_Diagnosed LEFT JOIN _Hierarchy HC ON HC.Id = P.HierarchyMapping_Current LEFT JOIN _Hierarchy HR ON HR.Id = P.HierarchyMapping_Residence LEFT JOIN Iam_Access_Mapping IAM on iam.entity_id=P.Id LEFT JOIN iam_imei_map IIM on IIM.iam_id=IAM.iam_id LEFT JOIN Iam_registration IIR on IIR.id = IAM.iam_id LEFT JOIN iam_adhtech IIA on IIA.id = IIR.adtech_id WHERE P.Stage in ('DIAGNOSED_ON_TREATMENT','DIAGNOSED_OUTCOME_ASSIGNED') And P.Deleted=0 AND ( (@HFsector=0) OR (@HFsector=1 and H.Type in ('PHI','ART')) OR (@HFsector=2 and H.Type in ('HUB','PVTLAB','PVTCHEM')) ) AND ( (@DateType=9 and cast(P.RegistrationDate AS date) between @startdate and @Enddate) OR (@DateType=11 and cast(P.DiagnosisDate AS date) between @startdate and @Enddate) OR (@DateType=14 and cast(P.TBTreatmentStartDate AS date) between @startdate and @Enddate) ) AND ( (@Gender=0 ) OR (@Gender=1 and P.Gender='Male') OR (@Gender=2 and P.Gender='Female') OR (@Gender=3 and P.Gender='Transgender') ) AND ( (@Age=0) OR (@Age=1 and P.Age<15) OR (@Age=2 and P.Age>=15) ) AND ( (@TBCaseTypes=0) OR (@TBCaseTypes=1 and (P.TypeOfCASE is Null OR P.TypeOfCASE in ('New','Retreatment: Others','Retreatment: Recurrent','Retreatment: Treatment after failure','Retreatment: Treatment after lost to follow up'))) OR (@TBCaseTypes=2 and P.TypeOfCase='PMDT') OR (@TBCaseTypes=3 and P.TypeOfCase like '%TPT%') ) AND ( (@SiteOfDisease=0) OR (@SiteOfDisease=1 and (P.SiteOfDisease is Null OR P.TypeOfCase='New')) OR (@SiteOfDisease=2 and P.SiteOfDisease='Extra Pulmonary') OR (@SiteOfDisease=3 and P.SiteOfDisease='Pulmonary') ) AND ( (@lateralLogin = 0 AND ( (@StateID=0 and @DistrictID=0 and @TbuID=0 and @HFID=0) OR (@StateID<>0 and @DistrictID=0 and @TbuID=0 and @HFID=0 and H.Level_2_Id=@StateID) OR (@StateID<>0 and @DistrictID<>0 and @TbuID=0 and @HFID=0 and H.Level_3_Id=@DistrictID) OR (@StateID<>0 and @DistrictID<>0 and @TbuID<>0 and @HFID=0 and H.Level_4_Id=@TbuID) OR (@StateID<>0 and @DistrictID<>0 and @TbuID<>0 and @HFID<>0 and H.Id=@HFID) ) ) OR (@lateralLogin = 1 AND ( (H.Level_2_ID in (select Hierarchy_ID from _Lateral_Login where H_Type='state'and Username=@Username)) and ( (@DistrictID=0 and H.Level_3_Id in (select Hierarchy_ID from _Lateral_Login where H_Type='District'and Username=@Username)) OR ( (@DistrictID<>0 and H.level_3_ID=@DistrictID and H.Level_3_Id in (select Hierarchy_ID from _Lateral_Login where H_Type='District'and Username=@Username)) and (@TbuID=0 or (@TbuID<>0 and H.Level_4_Id=@TbuID)) and (@HFID=0 or (@HFID<>0 and H.ID=@HFID)) ) ) ) ) ) AND ( ((H.Level_2_Code='AP' AND (H.Level_3_Code<>'ADB' AND H.Level_3_Code<>'BCL' AND H.Level_3_Code<>'HYD' AND H.Level_3_Code<>'KMR' AND H.Level_3_Code<>'KMM' AND H.Level_3_Code<>'MBR' AND H.Level_3_Code<>'MDK' AND H.Level_3_Code<>'NGD' AND H.Level_3_Code<>'NZD' AND H.Level_3_Code<>'RGY' AND H.Level_3_Code<>'WRL')) OR (H.Level_2_Code='AN' AND (H.Level_3_Code<>'ANI')) OR (H.Level_2_Code='TN' AND (H.Level_3_Code<>'CNI')) OR (H.Level_2_Code='TS' AND (H.Level_3_Code<>'WRL')) OR (H.Level_2_Code='WB' AND (H.Level_3_Code<>'CAL')) OR (H.Level_2_Code='MH' AND (H.Level_3_Code<>'BMC' AND H.Level_3_Code<>'MZ1' AND H.Level_3_Code<>'MZ2' AND H.Level_3_Code<>'MZ3' AND H.Level_3_Code<>'MZ4' AND H.Level_3_Code<>'MZ5' AND H.Level_3_Code<>'MZ6')) OR H.Level_2_Code IN ('AR','AS','BI','CG','CH','DD','DL','DM','DN','GA','GU','HP','HR','JH','JK','KA','KE','LK','MG','MN','MP','MZ','NG','OR','PD','PN','RJ','SK','TR','UP','UR','LD')) ) OPTION (RECOMPILE) END BEGIN Update #Temp_ARD SET calledDoses=ISNULL(TT.calledDoses,0), calledAndManualDoses =ISNULL(TT.calledAndManualDoses,0), total = ISNULL(TT.total,0), MissedDoses = ISNULL(TT.MissedDoses,0), ManualDoses =ISNULL(TT.ManualDoses,0) FROM #Temp_ARD TARD JOIN ( SELECT T.[Patient ID], T.Id [IIRId], calledDoses = (T.ENROLLMENT + T.RECEIVED + T.RECEIVED_UNSURE + T.ENDED + T.TFN_REPEAT_RECEIVED + T.TFN_REPEAT_RECEIVED_UNSURE + T.UNVALIDATED + T.RECEIVED_UNSCHEDULED), calledAndManualDoses = ((T.ENROLLMENT + T.RECEIVED + T.RECEIVED_UNSURE + T.ENDED + T.TFN_REPEAT_RECEIVED + T.TFN_REPEAT_RECEIVED_UNSURE + T.UNVALIDATED + T.RECEIVED_UNSCHEDULED) + T.MANUAL + T.PATIENT_MANUAL), total = (((T.ENROLLMENT + T.RECEIVED + T.RECEIVED_UNSURE + T.ENDED + T.TFN_REPEAT_RECEIVED + T.TFN_REPEAT_RECEIVED_UNSURE + T.UNVALIDATED + T.RECEIVED_UNSCHEDULED) + T.MANUAL + T.PATIENT_MANUAL) + T.MISSED + T.NO_INFO), MissedDoses = T.MISSED + T.NO_INFO + T.PATIENT_MISSED, ManualDoses = T.MANUAL + T.PATIENT_MANUAL FROM #Temp_ARD T ) AS TT ON TT.[Patient ID]=TARD.[Patient ID] and TT.[IIRId]=TARD.id END BEGIN SELECT T1.id [AdherenceId], T1.[Patient ID], T1.[Episode ID], T1.[Name], T1.PrimaryPhone, T1.Age, T1.Gender, T1.[Address], T1.[Current Facility - State], T1.[Current Facility - District], T1.[Current Facility - TU], T1.[Current Facility - PHI/ HF], T1.[Diagnosed Facility - State], T1.[Diagnosed Facility - District], T1.[Diagnosed Facility - TU], T1.[Diagnosed Facility - PHI/ HF], T1.[Health facility Sector Type], CASE WHEN (T1.[Type of Treatment] is Null OR T1.[Type of Treatment] in ('New','Retreatment: Others','Retreatment: Recurrent','Retreatment: Treatment after failure','Retreatment: Treatment after lost to follow up')) THEN 'DSTB' WHEN (T1.[Type of Treatment]='PMDT') THEN 'DRTB' WHEN (T1.[Type of Treatment] like '%TPT%') THEN 'TPT (TB Prevention Therapy)' END [Type of Treatment], T1.[Patient Status(Treatment Not Started/On Treatment)], T1.[Treatment initiation Date], T1.[AdherenceTech], T1.[TreatmentOutcome], T1.[Treatment Outcome Date], T1.[Residence Facility - State], T1.[Residence Facility - District], T1.[Residence Facility - TU], T1.total [TotalDoses], [Total number of Doses missed] = (T1.MISSED + T1.NO_INFO + T1.PATIENT_MISSED), [Total Number of doses taken] = (T1.total - (T1.MISSED + T1.NO_INFO + T1.PATIENT_MISSED)), [Average Adherence (Manual)] =FORMAT((CASE WHEN T1.ManualDoses=0 THEN 0.0 ELSE (T1.ManualDoses )*1.0/T1.total END),'P1'), AdherencePercentageManualMissed =FORMAT((CASE WHEN T1.MISSED=0 THEN 0.0 ELSE (T1.MISSED )*1.0/T1.total END),'P1'), [Unreported adherence] = FORMAT((CASE WHEN T1.NO_INFO=0 THEN 0.0 ELSE (T1.NO_INFO )*1.0/T1.total END),'P1'), [Average Adherence Tech] = FORMAT((CASE WHEN T1.calledDoses=0 THEN 0.0 ELSE (T1.calledDoses )*1.0/T1.total END),'P1'), [Average Adherence(Tech + Manual)] = FORMAT((CASE WHEN T1.calledAndManualDoses=0 THEN 0.0 ELSE (T1.calledAndManualDoses)*1.0/T1.total END),'P1'), [Doses taken last 3 days(Tech + Manual)] = T1.[Doses taken last 3 days(Tech + Manual)], [Doses taken last 7 days(Tech + Manual)] = T1.[Doses taken last 7 days(Tech + Manual)], [Doses taken last 30 days(Tech + Manual)] = T1.[Doses taken last 30 days(Tech + Manual)], [Adhererence string (day wise data)] = T1.[Adhererence string (day wise data)] FROM #Temp_ARD T1 ORDER BY T1.[Patient ID],T1.id END DROP TABLE #Temp_ARD END 